<!DOCTYPE html>
<meta charset="utf-8">
<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,800,700,600italic,600,300italic,300,700italic,800italic' rel='stylesheet' type='text/css'>
<style>

body {
  background: #232323;
  margin:0px;
}

div {margin:auto;}

svg.map {
  background: #232323;
}

.state {
  fill: #f8f8f8;
  stroke: #232323;
  stroke-linejoin: round;
  z-index: 0;
}

.state:hover {
  fill: #eee;
}
.rect{z-index: 1;}
.event {
  z-index: 2;
  fill: #e18a24;
  fill-opacity: 0.4;
}

.event:hover {
  r:6;
}
circle#White{fill:#362f96;}
circle#Black{fill:#ab0101;}
circle#Other{fill:#e18a24;}

.event.No{fill-opacity: 0.7;}
.event.Firearm{fill-opacity: 0.1;}

.overlay {
  fill: none;
  pointer-events: all;
}

div.center{
  width:1400px;
  border:4px solid #353535;
  text-align: center;
  font-family:'Open Sans';
  color:#f8f8f8;
  margin-top:25px;
  margin-bottom:100px;
}

div.map{border-bottom: 4px solid #353535;margin-bottom:15px;}

h1, h2{
  margin-top:0px;
  margin-bottom:10px;
  padding-top:5px;
  padding-bottom:10px;
  background: #353535;
}

a {color:#aaa;}

div.key{
  width: 550px;
  margin-right: 15px;
  display:inline-block;
  vertical-align: top;
}

div.key1{
  width:200px;
  padding:10px;
  display:inline-block;
}

div.key2{
  width:300px;
  padding:10px;
  display:inline-block;
}

svg.example{
  width:12px;
  height:12px;
}
.low-opacity{opacity:0.1}
.med-opacity{opacity:0.4}
.high-opacity{opacity:0.7}
h3{margin:0px 0px 5px 0px;text-decoration: underline;}

div.data-info{
  width:700px;
  display:inline-block;
}

p{text-align: left; text-indent: 2.0em;}

.axis path,
.axis line {
  fill: none;
  stroke: #f8f8f8;
  shape-rendering: crispEdges;
}

.x.axis path {
  display: none;
}

text {fill: #f8f8f8;}
g.Black{fill: #fff;}

.chart-container p{ width:80%; margin:auto;}

</style>
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<body>
  <div class='center'>
    <h1> Police Killings, 2015 to Present</h1>
    <div class='map'>
    </div>
    <div class='key'>
      <h2>Key</h2>
      <div class='key1'>
        <h3>Victim Race</h3>
        <svg class="example"><circle id="White" r="6" transform="translate(6,6)"></svg><span>&nbsp;&nbsp;=&nbsp;&nbsp;White</span><br />
        <svg class="example"><circle id="Black" r="6" transform="translate(6,6)"></svg><span>&nbsp;&nbsp;=&nbsp;&nbsp;Black&nbsp;</span><br />
        <svg class="example"><circle id="Other" r="6" transform="translate(6,6)"></svg><span>&nbsp;&nbsp;=&nbsp;&nbsp;Other</span>
      </div>
      <div class='key2'>
        <h3>Victim Status</h3>
        <span class="low-opacity">Low Opacity</span><span>&nbsp;&nbsp;=&nbsp;&nbsp;Armed with Firearm</span><br />
        <span class="med-opacity">Medium Opacity</span><span>&nbsp;&nbsp;=&nbsp;&nbsp;Other/Unknown</span><br />
        <span class="high-opacity">High Opacity</span><span>&nbsp;&nbsp;=&nbsp;&nbsp;Unarmed</span>
      </div>
    </div>
    <div class="data-info">
      <h2>Data Source</h2>
      <p>The data used in this visualization is from The Guardian's project entitled <a href="http://www.theguardian.com/us-news/ng-interactive/2015/jun/01/the-counted-police-killings-us-database" target="_blank">"The Counted"</a>.
        It is an ongoing project that tracks deaths resulting from police violence in the US. Their project does a very good job of statistics on a state-wide basis, as well as some interesting statistics based on race.
        I thought an interesting expansion of this would be to bring in the armed/unarmed element. Many police shootings are what may be called "suicide by police", which doesn't necessarily reflect any malfeasance or
        irresponsibility on the part of the police.</p>
      <p>Therefore, the interaction between race and whether the victim was armed seems important to analyze, as police misconduct is clearest when the victim was unarmed.</p>
    </div>
    <div class="chart-container">
      <h2>Proportional Deaths by Victim Status</h2>
      <div class="chart1"></div>
      <p>This chart illustrates that there is in fact a disparity between how differently armed victims have differing outcomes depending on their race. Most shocking is the clear disparity between Blacks and Native
       Americans and other racial groups. While unarmed, they are more than twice as likely to be killed by police, and nearly twice as likely to be killed regardless.</p> <br />
      <p>There are certainly arguments to be made regarding whether it is fair to measure these distinctions purely on a racial basis. It is very likely that there are factors such as share of violent crime committed,
      and socioeconomic factors beneath those. Nonetheless, the fact that there is twice the likelihood of an <b>unarmed</b> person of certain races to be killed over other races is something that is unlikely to be
      explained away by other factors.</p>
      <br />
    </div>

<script>
/******************CHART********************/
var margin = {top: 20, right: 20, bottom: 30, left: 40},
    chartwidth = 1200 - margin.left - margin.right,
    chartheight = 600 - margin.top - margin.bottom;

var x = d3.scale.ordinal()
    .rangeRoundBands([0, chartwidth], .15);

var y = d3.scale.linear()
    .rangeRound([chartheight, 0]);

var color = d3.scale.ordinal()
    .range(["rgba(255,255,255,0.7)", "rgba(255,255,255,0.4)", "rgba(255,255,255,0.1)"]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .tickFormat(d3.format(".2s"));

var chartsvg = d3.select("div.chart1").append("svg")
    .attr("width", chartwidth + margin.left + margin.right)
    .attr("height", chartheight + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

d3.csv("chart1.csv", function(error, data) {
  if (error) throw error;

  color.domain(d3.keys(data[0]).filter(function(key) { return key !== "race"; }));

  data.forEach(function(d) {
    var y0 = 0;
    d.deaths = color.domain().map(function(name) { return {name: name, y0: y0, y1: y0 += +d[name]}; });
    d.total = d.deaths[d.deaths.length - 1].y1;
  });

  data.sort(function(a, b) { return b.total - a.total; });

  x.domain(data.map(function(d) { return d.race; }));
  y.domain([0, 10]);

  chartsvg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + chartheight + ")")
      .call(xAxis);

  chartsvg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Deaths per Million");

  var state = chartsvg.selectAll(".population")
      .data(data)
    .enter().append("g")
      .attr("class", "g")
      .attr("transform", function(d) { return "translate(" + x(d.race) + ",0)"; });

  state.selectAll("rect")
      .data(function(d) { return d.deaths; })
    .enter().append("rect")
      .attr("width", x.rangeBand())
      .attr("y", function(d) { return y(d.y1); })
      .attr("height", function(d) { return y(d.y0) - y(d.y1); })
      .style("fill", function(d) { return color(d.name); });

  state.selectAll('text')
      .data(function(d) {return d.deaths; })
    .enter().append('text')
      .attr('x', x.rangeBand()/2)
      .attr("y", function(d, i) { return y(d.y1) + (y(d.y0) - y(d.y1))/2; })
      .style('text-anchor', 'middle')
      .text(function(d) { return (d.y1 - d.y0).toFixed(2); });

  var legend = chartsvg.selectAll(".legend")
      .data(color.domain().slice().reverse())
    .enter().append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  legend.append("rect")
      .attr("x", chartwidth - 18)
      .attr("width", 18)
      .attr("height", 18)
      .style("fill", color);

  legend.append("text")
      .attr("x", chartwidth - 24)
      .attr("y", 9)
      .attr("dy", ".35em")
      .attr('class', function(d) { return d; })
      .style("text-anchor", "end")
      .text(function(d) { return d; });

});


/******************MAPPING******************/
var width = 1400,
    height = 700;

var projection = d3.geo.albersUsa()
    .translate([width / 2, height / 2])
    .scale(1500);

var zoom = d3.behavior.zoom()
    .scaleExtent([1, 12])
    .on("zoom", zoomed);

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select("div.map").append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr('class', 'map')
  .append("g");

var g = svg.append("g");

svg.append("rect")
    .attr("class", "overlay")
    .attr("width", width)
    .attr("height", height);

svg
    .call(zoom)
    .call(zoom.event);

d3.json("states.json", function(error, UnitedStates) {
  if (error) throw error;

  var states = UnitedStates.features

  for (var i = 0; i < states.length; i++) {
  g.append("path")
      .datum(states[i])
      .attr('class', function(d) {return 'state ' + d.properties.name; })
      .attr("d", path);
  }

  d3.json("event_points.json", function(error, events) {
    if (error) return console.error(error);

  for (var i = 0; i < events.length; i++) {
    g.append('circle')
      .datum(events[i])
      .attr('id', function(d) {return d['race']; })
      .attr('class', function(d) {return 'event ' + d['date_index'] + " " + d['armed']; })
      .attr('r', 1.5)
      .attr("transform", function(d) {return "translate(" + projection([d["long"],d["lat"]]) + ")";})
    .append('title')
      .text(function(d) {return d['race'] + " " + d['sex'] + ", Armed: " + d['armed']; });
  }

  });

});

function zoomed() {
  g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
}

d3.select(self.frameElement).style("height", height + "px");

</script>
  </div>
